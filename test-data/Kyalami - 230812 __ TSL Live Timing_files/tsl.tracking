Tracking=function(){function nt(){var n=tsl.liveTiming.getDriver($("#watchNumberText").val());n&&n.toggleColour()}function k(n){for(var t=tsl.liveTiming.drivers(),i=t.length;i--;)t[i].ID()===n&&(t[i].div().remove(),t.splice(i,1))}function et(n){k(n),tsl.liveTiming.drivers.remove(tsl.liveTiming.getDriverByID(n))}function lt(){gt=document.localTracking;var n=tsl.shared.parseQueryString();n.mode==="display"&&($("#TrackingDiv").addClass("display"),y=2,$(document).keyup(function(n){if(n.altKey){var t=parseInt(n.key);isNaN(t)||a(t)}})),$("#TrackingClassification").accordion({active:!1,collapsible:!0,heightStyle:"content"}),$("#Drivers").accordion({active:!1,collapsible:!0,heightStyle:"content"}),$("#toggleWatchNoButton").click(nt),$("#watchNumberText").keydown(function(n){n.keyCode==13&&nt()}),$("#nth_item_button").button().click(function(){$("#TrackingClassification").dialog("isOpen")?$("#TrackingClassification").dialog("close"):$("#TrackingClassification").dialog("open"),c()}),$("#HideNumbers").click(function(){h?($(".competitor > div").show(),$("#HideNumbers").val("Hide Numbers")):($(".competitor > div").hide(),$("#HideNumbers").val("Show Numbers")),h=!h}),$("#CurrentEllipse").dialog({autoOpen:!1,resizable:!1,dialogClass:"driverPopup",height:30,width:"auto",position:{my:"left top",at:"center",of:competitorContainer}}),$("#blobScaleSelector").change(function(n){a(n.currentTarget.value)}),$(window).resize(function(){clearTimeout(it),it=setTimeout(c,100)})}function wt(){ti(n),n=$.connection.liveTiming;n.on("updateSession",v);n.on("updateResult",p);n.on("isFirstBroadcast",b);n.on("mapAnimate",d);n.on("RemoveAnimation",k);n.on("removeCompetitor",et);n.on("controlBroadcast",w)}function w(n){var u=n.Message.substring(10),t=u.split(" "),r;if(u.substring(0,23)==="YELLOW FLAGS IN SECTOR ")g("Yellow",t[4]);else if(t[0]=="SECTOR"&&t[2]=="GREEN")g(t[2],t[1]);else if(t.length==2&&t[1]=="FLAG")for(r=0;r<i.length;r++)t[0]=="GREEN"||t[0]=="CHEQUERED"?i[r].attr("fill","Grey"):i[r].attr("fill","Red");else if(t.length==2&&t[0]=="SAFETY")for(r=0;r<i.length;r++)i[r].attr("fill","Yellow")}function p(n){typeof NullableDriverObject!="undefined"&&NullableDriverObject!==null&&NullableDriverObject.update(n),n.Pos===1&&b(n.ID),n.InPits?yt(n):vt(n),n.Status=="Missing"?at(new MissingDriver(n)):ni(n.ID);var t=tsl.liveTiming.getDriverByID(n.ID);t&&(t.Name(n.Name),t.StartNumber(n.StartNumber),$(".trackingBlobNumber",t.div()).text(n.StartNumber),n.PIC&&t.div().attr("data-pic",n.PIC))}function d(n){if(n.SectorTime>-1){var t=tsl.liveTiming.getDriverByID(n.CompetitorID);if(t)t.StartNumber(n.StartNumber),t.Name(n.Name),t.ClassItem(tsl.liveTiming.getClassByID(n.ClassID)),t.UtilityVehicle=n.UtilityVehicle,t.lastSectorMessageTOD=tsl.shared.ambTimeStampUTCNow(),t.lastSectorTime=n.SectorTime,t.startPoint=n.StartPointPer,t.animateTo=n.EndPointPer,$(".trackingBlobNumber",t.div()).text(n.StartNumber);else{pt(n);return}}else tsl.liveTiming.clearCompetitors()}function c(){var r,n,e,f,h,i,c,v,a;if(typeof trackData!="undefined"&&trackData!=undefined){if(r=$("#TrackingDiv #container"),e=$("#FloatOptions"),n=e.length>0?e.offset().top:$(window).height(),u&&u!=NaN&&n>u&&(n=u),f=n-r.offset().top,r.height(f),h=r.width()-$("#ContainerMissing").width()-5,i=Math.min(f/trackData.height,h/trackData.width),$(".trackResize").height(trackData.height*i),$(".trackResize").width(trackData.width*i),$("#imageContainer").css({"margin-left":(h-$("#trackImage").width())/2}),$("#imageContainer").css({"margin-top":(f-$("#trackImage").height())/2}),$("#table").height($("#imageContainer").height()-$("#Div2").height()),l=$("#trackImage").height()/trackData.height,s=$("#trackImage").width()/trackData.width,$(".competitor").each(function(){o($(this))}),t)for(t.setSize($("#trackImage").width(),$("#trackImage").height()),c=1,v=i<1?10*i:5;;){if(a=t.getById("Sector_"+c),a==null)break;a.attr("stroke-width",v),c++}tsl.liveTiming.viewModel.watchHeight($("#trackImage").height()+"px")}}function pt(n){var f,t,u,i,r;return"trackData"in window?(f=$("#competitorContainer"),t=$(document.createElement("div")),t.addClass("competitor"),n.CompetitorID==e&&t.addClass("leader"),t.attr("data-pic",n.PIC),u=$(document.createElement("div")).text(n.StartNumber).css({display:"block"}).addClass("trackingBlobNumber"),h&&u.hide(),t.append(u),n.StartNumber==$("#watchValue").val()&&t.addClass("watching"),n.UtilityVehicle&&t.addClass("utilityVehicle"),t.hover(function(){if(n.CompetitorID!=null){var t=tsl.liveTiming.getDriverByID(n.CompetitorID);t!=null&&($("#CurrentEllipse").html(t.StartNumber()+" : "+t.Name()).dialog({autoOpen:!1,resizable:!1,dialogClass:"driverPopup",height:30,width:"auto",position:{my:"left top",at:"center",of:competitorContainer}}),$("#CurrentEllipse").dialog("open"))}},function(){$("#CurrentEllipse").html(" ").dialog("close")}).mousemove(function(t){var i=n.StartNumber.length+n.Name.length+3;$("#CurrentEllipse").dialog("option",{position:[t.pageX-50,t.pageY+5]})}).click(function(){for(var e=[],o=tsl.liveTiming.drivers(),s=o.length,h=t.position().top,c=t.position().left,l,r,f,u;s--;)l=o[s],r=o[s].div(),r.position().top>h-20&&r.position().top<h+20&&r.position().left>c-20&&r.position().left<c+20&&n.CompetitorID!=null&&(f=tsl.liveTiming.getDriverByID(l.ID()),f!=null&&e.push(f.StartNumber()+" : "+f.Name()));u="<div> ",e.forEach(function(n){u+=n+"<br />"}),u+="<div />",$("#CurrentEllipse").html(u).dialog({height:""+e.length*30+"",width:"auto",autoResize:"true"}),$("#CurrentEllipse").html(u).dialog("open")}),i=new DriverInfo(n.CompetitorID,n.StartNumber,null,n.Name,t),i.lastSectorMessageTOD=tsl.shared.ambTimeStampUTCNow(),i.lastSectorTime=n.SectorTime,i.startPoint=~~n.StartPointPer,i.animateTo=~~n.EndPointPer,i.utilityVehicle=n.UtilityVehicle,t.css({left:trackData.Coordinates[i.startPoint][0]*s,top:trackData.Coordinates[i.startPoint][1]*l}),f.append(t),o(t),r=tsl.liveTiming.getClassByID(n.ClassID),r!=undefined?(t.css("background-color",r.Colour()),t.css("color",r.ForeColour()),t.attr("data-class",r.ID),i.ClassItem(r),r.shown()||t.hide()):(t.css("background-color","#FFFFFF"),t.attr("data-class",n.ClassID)),tsl.liveTiming.drivers.push(i),i):0}function yt(n){for(var t=tsl.liveTiming.viewModel.inPit().length,i;t--;)if(tsl.liveTiming.viewModel.inPit()[t].Id==n.ID){tsl.liveTiming.viewModel.inPit()[t].StartNumber(n.StartNumber);return}i=tsl.liveTiming.getDriverByID(n.ID),i&&i.div().detach(),tsl.liveTiming.viewModel.inPit.push(new PittedDriver(n.ID,n.StartNumber))}function vt(n){for(var t=tsl.liveTiming.viewModel.inPit,i=t().length,u=null,r,f;i--;)if(t()[i].Id==n.ID){u=t()[i],t.remove(t()[i]);break}u!=null&&(r=tsl.liveTiming.getDriverByID(n.ID),r&&(o(r.div()),f=$("#competitorContainer"),f.append(r.div())))}function at(n){var r=tsl.liveTiming.getDriverByID(n.ID),t,i;for(r&&r.div().detach(),t=tsl.liveTiming.missingDrivers,i=t().length;i--;)if(t()[i].ID==n.ID){t()[i].StartNumber(n.StartNumber()),t()[i].Sector(n.Sector());return}tsl.liveTiming.missingDrivers.push(n),tsl.liveTiming.missingDrivers.sort(function(n,t){return n.Sector()==t.Sector()?parseInt(n.StartNumber())<parseInt(t.StartNumber())?-1:1:n.Sector()<t.Sector()?-1:1})}function ni(n){for(var t=tsl.liveTiming.missingDrivers,r=t().length,i,u;r--;)if(t()[r].ID==n){t.remove(t()[r]),i=tsl.liveTiming.getDriverByID(n),i&&(o(i.div()),u=$("#competitorContainer"),u.append(i.div()));break}}function o(n){var t=20,i=(trackData.width/46*s>t?trackData.width/46*s:t)*y,r=i+i/3,u;n.height(i),n.width(r),n.css({"margin-top":-~~(i/2),"margin-left":-~~(r/2)}),u=16*(n.height()/t)>.5?n.height()/t:.5,n.css({"font-size":16*u+"px"})}function ut(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||function(n){window.setTimeout(n,50)},window.requestAnimationFrame(ht)}function ht(){for(var i=tsl.liveTiming.drivers(),u=i.length,o,h;u--;){var n=i[u],f=i[u].div(),c=n.animateTo-n.startPoint,a=c/n.lastSectorTime,e=tsl.shared.ambTimeStampUTCNow()-n.lastSectorMessageTOD,t=n.startPoint+~~(e*a);if(tsl.liveTiming.viewModel.SessionState()==="Yellow"?(o=22.352,n.safetyCarInit?(n.startPoint!==n.safetyCarInit.sectorStart||e<n.safetyCarInit.timeIntoSegment)&&(n.safetyCarInit={sectorStart:null,startPoint:n.startPoint,timeIntoSegment:0}):n.safetyCarInit={sectorStart:n.startPoint,startPoint:t,timeIntoSegment:e},h=e-n.safetyCarInit.timeIntoSegment,t=~~(n.safetyCarInit.startPoint+h/1e3*o)):n.safetyCarInit=null,t>=n.animateTo&&(t=n.animateTo),tsl.liveTiming.viewModel.SessionState()==="Green"&&n.utilityVehicle&&(n.StartNumber().startsWith("SC")||n.StartNumber().startsWith("sc"))&&t==n.animateTo){n.div().remove(),i.splice(u,1);continue}t=~~t;try{trackData.Coordinates&&trackData.Coordinates[t]&&(f.css("top",~~(trackData.Coordinates[t][1]*l)),f.css("left",~~(trackData.Coordinates[t][0]*s)))}catch(v){console.error(v)}r!=0?f.css({"-webkit-transform":"rotate("+-r+"deg)","-moz-transform":"rotate("+-r+"deg)","-ms-transform":"rotate("+-r+"deg)","-o-transform":"rotate("+-r+"deg)",transform:"rotate("+-r+"deg)"}):f.css({"-webkit-transform":"initial","-moz-transform":"initial","-ms-transform":"initial","-o-transform":"initial",transform:"initial"})}ut()}function v(n){var u,f,e,r;if(n.TrackName!=null&&(u=n.TrackName.replace(/[" "]/g,"_"),tsl.liveTiming.currentFilePrefix!==u))if(tsl.liveTiming.currentFilePrefix=u,f="/Tracks/",document.localTracking||(f="https://tslproduction.blob.core.windows.net/tracks/"),e=f+u+".svg",e.indexOf("null")<0){r=$("#trackImage"),r.data("vectron")&&(r.off(".vectron"),r.removeData("vectron"),r.empty()),r.attr("data-svg",e);r.on("complete.vectron",function(){t=r.data("vectron").paper,$("#trackImage").show(),$("#NoTrackMessage").hide(),$.getScript(f+u+".js",function(){var n,r,u,f,e;kt=trackData.width,dt=trackData.height,Raphael.type=="VML"&&t.setSize(trackData.width,trackData.height),t.setViewBox(0,0,trackData.width,trackData.height),t.canvas.setAttribute("preserveAspectRatio","none"),n=t.getById("Sector_1"),n&&(i.push(n),n.attr({stroke:"#75B72A","stroke-width":5,fill:"Grey"})),r=t.getById("Sector_2"),r&&(i.push(r),r.attr({stroke:"#FFD640","stroke-width":5,fill:"Grey"})),u=t.getById("Sector_3"),u&&(i.push(u),u.attr({stroke:"#C84693","stroke-width":5,fill:"Grey"})),f=t.getById("Sector_4"),f&&(i.push(f),f.attr({stroke:"#0081FF","stroke-width":5,fill:"Grey"})),e=t.getById("Sector_5"),e&&(i.push(e),e.attr({stroke:"#FA8072","stroke-width":5,fill:"Grey"})),c(),ut(),bt()})});r.vectron()}else $("#trackImage").hide(),$("#NoTrackMessage").show()}function b(n){var t,i;e!=n&&(e!=0&&(t=tsl.liveTiming.getDriverByID(e),t&&t.div()&&t.div().removeClass("leader")),i=tsl.liveTiming.getDriverByID(n),i&&i.div()&&i.div().addClass("leader"),e=n)}function g(n,t){var r=n,u=t-1;n=="GREEN"&&(r="GREY"),u<i.length&&i[u].attr("fill",r)}function ct(n){var t=r;t=n=="l"?r==0?315:r-45:r+45,t==360&&(t=0),ft(t)}function a(n){n>=1&&n<=4&&(y=n,$(".competitor").each(function(){o($(this))}),ot(n))}function ft(n){var t=$("#trackContainer"),i=1,u,e;n!=0&&n!=180&&t.width()>t.height()&&(i=t.height()/t.width(),f=Math.atan(t.width()/t.height()),rt=Math.sqrt(Math.pow(t.height(),2)+Math.pow(t.width(),2)),u=n*Math.PI/180,e=n<90?u-f:n<180?u+f:n<270?u-f:u+f,i=t.height()/Math.cos(e)/rt,i<0&&(i=-i)),t.css({"-webkit-transform":"rotate("+n+"deg) scale("+i+")","-moz-transform":"rotate("+n+"deg) scale("+i+")","-ms-transform":"rotate("+n+"deg) scale("+i+")","-o-transform":"rotate("+n+"deg) scale("+i+")",transform:"rotate("+n+"deg) scale("+i+")"}),r=n,st(n)}function st(n){var t=new Date,i;t.setDate(t.getDate()+7),i="expires="+t.toUTCString(),document.cookie="rotate="+n+";"+i+";path=/"}function ot(n){var t=new Date,i;t.setDate(t.getDate()+7),i="expires="+t.toUTCString(),document.cookie="blobScale="+n+";"+i+";path=/"}function bt(){var n;n=tsl.shared.readCookieValue("rotate"),!isNaN(n)&&n>=0&&n<=360&&ft(n),n=tsl.shared.readCookieValue("blobScale"),isNaN(n)||a(n)}function ti(){n&&(n.off("updateSession",v),n.off("updateResult",p),n.off("isFirstBroadcast",b),n.off("mapAnimate",d),n.off("RemoveAnimation",k),n.off("removeCompetitor",et),n.off("controlBroadcast",w))}var n,t,it,gt=!1,dt,kt,l=1,s=1,i=tsl.liveTiming.sectors,ri=["#CCFFCC","#00ffff","#ff00ff","#FFCC00","#c0c0c0","#0000ff","#800080","#ffffff"],h=!1,e=0,y=1,r=0,f,ii,rt,u=null,tt=tsl.shared.parseQueryString();return tt.maxHeight&&(u=parseFloat(tt.maxHeight)),lt(),{onConnected:wt,updateSession:v,scalePath:c,rotateMap:ct,processCompetitorMessage:p,processRaceControlMessage:w}}()